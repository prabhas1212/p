<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>P-AI Streaming Assistant</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        :root {
            --primary-color: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --bg-color: #f0f2f5;
            --card-color: white;
            --text-color: #1f2937;
            --text-light: white;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --border-radius: 15px;
            --message-radius: 20px;
            --animation-duration: 0.3s;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --card-color: #1e1e1e;
                --text-color: #e5e7eb;
                --text-light: #f3f4f6;
                --shadow: 0 10px 30px rgba(0,0,0,0.3);
            }
            
            .bot-message {
                background: #2d2d2d !important;
            }
            
            #user-input {
                background: #2d2d2d;
                color: var(--text-light);
                border-color: #3d3d3d;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-color);
            color: var(--text-color);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .chat-container {
            width: 95vw;
            max-width: 500px;
            height: 90vh;
            max-height: 800px;
            background: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all var(--animation-duration) ease;
            position: relative;
        }

        .chat-header {
            padding: 1.5rem;
            background: var(--primary-gradient);
            color: var(--text-light);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
        }

        .chat-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: var(--message-radius);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: pre-wrap;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(10px);
            animation: messageIn var(--animation-duration) ease forwards;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        @keyframes messageIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: var(--primary-color);
            color: var(--text-light);
            align-self: flex-end;
            border-radius: var(--message-radius) var(--message-radius) 0 var(--message-radius);
            animation-delay: 0.1s;
        }

        .bot-message {
            background: var(--bg-color);
            color: var(--text-color);
            align-self: flex-start;
            border-radius: var(--message-radius) var(--message-radius) var(--message-radius) 0;
        }

        .input-container {
            padding: 1rem;
            display: flex;
            gap: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
            background: var(--card-color);
            position: relative;
            z-index: 5;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            outline: none;
            font-size: 14px;
            transition: all 0.2s ease;
            min-height: 44px;
        }

        #user-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            min-width: 44px;
            min-height: 44px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        #send-btn {
            background: var(--primary-color);
            color: var(--text-light);
        }

        #send-btn:hover {
            background: #4f46e5;
        }

        #voice-btn {
            background: var(--secondary-color);
            color: var(--text-light);
        }

        #voice-btn:hover {
            background: #0d9488;
        }

        #image-btn {
            background: var(--accent-color);
            color: var(--text-light);
        }

        #image-btn:hover {
            background: #d97706;
        }

        .streaming-line {
            display: block;
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 5px;
            border: 2px solid rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .image-preview.loaded {
            opacity: 1;
            transform: scale(1);
        }

        .upload-container {
            position: relative;
            display: inline-block;
        }

        #file-input {
            display: none;
        }

        .ocr-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-top: 5px;
        }

        .ocr-error {
            color: #ef4444;
            font-size: 0.9em;
            margin-top: 5px;
            animation: shake 0.5s ease;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-color);
            border-radius: var(--message-radius);
            margin-left: 8px;
            width: fit-content;
            animation: messageIn var(--animation-duration) ease forwards;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .message-actions {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.1);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(0,0,0,0.2);
            transform: scale(1.1);
        }

        .bot-message .message-actions {
            left: -25px;
            right: auto;
        }

        .listening {
            animation: pulse 1.5s infinite, colorChange 3s infinite alternate;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        @keyframes colorChange {
            0% { background-color: var(--secondary-color); }
            50% { background-color: #3b82f6; }
            100% { background-color: var(--secondary-color); }
        }

        /* Floating action button for mobile */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .fab.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .fab:active {
            transform: scale(0.95) translateY(0);
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Scrollbar styling */
        .chat-body::-webkit-scrollbar {
            width: 6px;
        }

        .chat-body::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .chat-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }

        /* Platform-specific adjustments */
        @supports (-webkit-touch-callout: none) {
            /* iOS specific styles */
            body {
                padding-bottom: constant(safe-area-inset-bottom);
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .input-container {
                padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            }
            
            .btn {
                min-height: 44px; /* Apple's recommended touch target size */
            }
        }

        /* Windows high contrast mode */
        @media (-ms-high-contrast: active) {
            .message {
                border: 1px solid;
            }
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(99, 102, 241, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            color: var(--text-color);
            opacity: 0;
            animation: fadeInOut 2s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status.visible {
            opacity: 1;
        }

        .connection-status.connected {
            background: var(--secondary-color);
        }
    </style>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing P-AI Assistant...</div>
    </div>

    <div class="connection-status" id="connection-status">Connection lost. Reconnecting...</div>

    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <h3>P-AI Streaming Assistant</h3>
            <div class="connection-dot" id="connection-dot"></div>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="message bot-message">
                <div class="streaming-line">Hello! I'm your Prabhas-AI assistant.</div>
                <div class="streaming-line" style="animation-delay: 0.3s">You can type, speak, or upload images.</div>
                <div class="streaming-line" style="animation-delay: 0.6s">Ask me anything!</div>
                <div class="message-actions">
                    <button class="action-btn" title="Speak" onclick="speakMessage(this.parentNode.parentNode)">ðŸ”Š</button>
                    <button class="action-btn" title="Copy" onclick="copyMessage(this.parentNode.parentNode)">âŽ˜</button>
                </div>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message..." aria-label="Type your message">
            <div class="upload-container">
                <input type="file" id="file-input" accept="image/*" aria-label="Upload image">
                <button id="image-btn" class="btn" title="Upload Image" onclick="document.getElementById('file-input').click()" aria-label="Upload image">
                    ðŸ“·
                </button>
            </div>
            <button id="voice-btn" class="btn" title="Voice Input" aria-label="Voice input">ðŸŽ¤</button>
            <button id="send-btn" class="btn" title="Send" aria-label="Send message">âž¤</button>
        </div>
    </div>

    <div class="fab" id="scroll-to-bottom" aria-label="Scroll to bottom">â†“</div>

    <script>
        // Wait for everything to load
        document.addEventListener('DOMContentLoaded', async () => {
            // Simulate loading time (remove in production)
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
            }, 1500);
            
            // Initialize components
            initChat();
        });

        // Main chat initialization
        function initChat() {
            const chatBody = document.getElementById('chat-body');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            const fileInput = document.getElementById('file-input');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom');
            const chatContainer = document.getElementById('chat-container');
            const API_KEY = 'OPENROUTER_API_KEY_PLACEHOLDER';
            
            // Check connection status
            let isOnline = navigator.onLine;
            const connectionStatus = document.getElementById('connection-status');
            
            window.addEventListener('online', () => {
                isOnline = true;
                connectionStatus.textContent = 'Connected';
                connectionStatus.classList.add('connected');
                setTimeout(() => {
                    connectionStatus.classList.remove('visible');
                }, 2000);
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                connectionStatus.textContent = 'Connection lost. Reconnecting...';
                connectionStatus.classList.remove('connected');
                connectionStatus.classList.add('visible');
            });
            
            // Speech synthesis
            const synth = window.speechSynthesis;
            let currentUtterance = null;
            
            // Initialize Tesseract OCR
            const worker = Tesseract.createWorker();
            (async () => {
                try {
                    await worker.load();
                    await worker.loadLanguage('eng');
                    await worker.initialize('eng');
                } catch (error) {
                    console.error('OCR initialization failed:', error);
                }
            })();
            
            // Add ripple effect to buttons
            function createRipple(event) {
                const button = event.currentTarget;
                const circle = document.createElement("span");
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;
                
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
                circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
                circle.classList.add("ripple");
                
                const ripple = button.getElementsByClassName("ripple")[0];
                if (ripple) ripple.remove();
                
                button.appendChild(circle);
            }
            
            const buttons = document.querySelectorAll('.btn, .action-btn');
            buttons.forEach(button => {
                button.addEventListener('click', createRipple);
            });
            
            // Show/hide scroll to bottom button
            chatBody.addEventListener('scroll', () => {
                const scrollThreshold = 100;
                const isNearBottom = chatBody.scrollHeight - chatBody.scrollTop - chatBody.clientHeight > scrollThreshold;
                
                if (isNearBottom) {
                    scrollToBottomBtn.classList.add('visible');
                } else {
                    scrollToBottomBtn.classList.remove('visible');
                }
            });
            
            scrollToBottomBtn.addEventListener('click', () => {
                chatBody.scrollTo({
                    top: chatBody.scrollHeight,
                    behavior: 'smooth'
                });
            });
            
            // Image upload handler
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (limit to 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError("Image size should be less than 5MB");
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    const container = document.createElement('div');
                    container.className = 'message user-message';
                    container.innerHTML = `
                        <div>Uploaded Image:</div>
                        <img src="${img.src}" class="image-preview">
                        <div class="ocr-loading"></div>
                    `;
                    chatBody.appendChild(container);
                    scrollToBottom();
                    
                    try {
                        const { data: { text } } = await worker.recognize(file);
                        container.innerHTML = `
                            <div>Uploaded Image:</div>
                            <img src="${img.src}" class="image-preview loaded">
                            <div style="margin-top: 5px">Extracted Text: ${text}</div>
                        `;
                        await handleStreamingResponse(`Image content: ${text}`);
                    } catch (error) {
                        console.error('OCR Error:', error);
                        container.innerHTML += `<div class="ocr-error">OCR Failed: ${error.message}</div>`;
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // Show error message
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message bot-message';
                errorDiv.innerHTML = `<div class="ocr-error">${message}</div>`;
                chatBody.appendChild(errorDiv);
                scrollToBottom();
            }
            
            // Show typing indicator
            function showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot" style="animation-delay: 0.2s"></div>
                    <div class="typing-dot" style="animation-delay: 0.4s"></div>
                `;
                chatBody.appendChild(typingDiv);
                scrollToBottom();
                return typingDiv;
            }
            
            // Create streaming message
            function createStreamingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="action-btn" title="Speak" onclick="speakMessage(this.parentNode.parentNode)">ðŸ”Š</button>
                    <button class="action-btn" title="Copy" onclick="copyMessage(this.parentNode.parentNode)">âŽ˜</button>
                `;
                messageDiv.appendChild(actionsDiv);
                
                chatBody.appendChild(messageDiv);
                scrollToBottom();
                return messageDiv;
            }
            
            // Add streaming text
            function addStreamingText(container, text) {
                const lines = text.split('\n');
                lines.forEach((line, index) => {
                    if (line.trim() === '') return;
                    
                    if (index >= container.children.length - 1) {
                        const lineElement = document.createElement('div');
                        lineElement.className = 'streaming-line';
                        lineElement.style.animationDelay = `${index * 0.3}s`;
                        container.insertBefore(lineElement, container.lastChild);
                    }
                    
                    const lineElement = container.children[index];
                    lineElement.textContent = line;
                });
                scrollToBottom();
            }
            
            // Scroll to bottom of chat
            function scrollToBottom() {
                setTimeout(() => {
                    chatBody.scrollTo({
                        top: chatBody.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
            
            // Text-to-speech
            window.speakMessage = function(messageElement) {
                if (currentUtterance) synth.cancel();
                
                let fullText = '';
                for (let i = 0; i < messageElement.children.length - 1; i++) {
                    if (messageElement.children[i].classList.contains('streaming-line')) {
                        fullText += messageElement.children[i].textContent + ' ';
                    }
                }
                
                if (fullText.trim()) {
                    currentUtterance = new SpeechSynthesisUtterance(fullText);
                    currentUtterance.rate = 1.0;
                    currentUtterance.pitch = 1.0;
                    
                    // Add event listeners for better UX
                    currentUtterance.onstart = () => {
                        messageElement.classList.add('speaking');
                    };
                    
                    currentUtterance.onend = () => {
                        messageElement.classList.remove('speaking');
                    };
                    
                    synth.speak(currentUtterance);
                }
            }
            
            // Copy message to clipboard
            window.copyMessage = function(messageElement) {
                let fullText = '';
                for (let i = 0; i < messageElement.children.length - 1; i++) {
                    if (messageElement.children[i].classList.contains('streaming-line')) {
                        fullText += messageElement.children[i].textContent + '\n';
                    }
                }
                
                if (fullText.trim()) {
                    navigator.clipboard.writeText(fullText.trim()).then(() => {
                        const originalText = messageElement.querySelector('.action-btn[title="Copy"]').textContent;
                        messageElement.querySelector('.action-btn[title="Copy"]').textContent = 'âœ“';
                        setTimeout(() => {
                            messageElement.querySelector('.action-btn[title="Copy"]').textContent = originalText;
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                }
            }
            
            // Handle AI response
            async function handleStreamingResponse(prompt) {
                if (!isOnline) {
                    connectionStatus.classList.add('visible');
                    showError("You're offline. Please check your internet connection.");
                    return;
                }
                
                const typing = showTyping();
                const messageContainer = createStreamingMessage();
                let fullResponse = '';
                
                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${API_KEY}`,
                            "HTTP-Referer": "https:zu38.github.io",
                            "X-Title": "PAI Chatbot",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "model": "mistralai/mistral-small-3.1-24b-instruct:free",
                            "messages": [{"role": "user", "content": prompt}],
                            "stream": true
                        })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (line.startsWith('data:') && !line.includes('[DONE]')) {
                                try {
                                    const data = JSON.parse(line.substring(5));
                                    if (data.choices[0].delta?.content) {
                                        fullResponse += data.choices[0].delta.content;
                                        addStreamingText(messageContainer, fullResponse);
                                    }
                                } catch (e) {
                                    console.error('Error parsing stream data:', e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Stream error:', error);
                    addStreamingText(messageContainer, `Error: ${error.message}`);
                } finally {
                    typing.remove();
                }
            }
            
            // Voice input
            function handleVoiceInput() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    showError("Your browser doesn't support speech recognition. Try Chrome or Edge.");
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                voiceBtn.classList.add('listening');
                
                recognition.onstart = () => {
                    userInput.placeholder = "Listening...";
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    voiceBtn.classList.remove('listening');
                    userInput.placeholder = "Type your message...";
                    handleUserInput();
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    voiceBtn.classList.remove('listening');
                    userInput.placeholder = "Type your message...";
                    
                    let errorMessage = "Voice input failed";
                    if (event.error === 'not-allowed') {
                        errorMessage = "Please allow microphone access for voice input.";
                    } else if (event.error === 'no-speech') {
                        errorMessage = "No speech detected. Please try again.";
                    }
                    
                    showError(errorMessage);
                };
                
                recognition.onend = () => {
                    voiceBtn.classList.remove('listening');
                    userInput.placeholder = "Type your message...";
                };
                
                recognition.start();
            }
            
            // Handle user input
            async function handleUserInput() {
                const message = userInput.value.trim();
                if (!message) return;
                
                const userMsg = document.createElement('div');
                userMsg.className = 'message user-message';
                userMsg.textContent = message;
                chatBody.appendChild(userMsg);
                userInput.value = '';
                scrollToBottom();
                
                await handleStreamingResponse(message);
            }
            
            // Event listeners
            sendBtn.addEventListener('click', handleUserInput);
            voiceBtn.addEventListener('click', handleVoiceInput);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleUserInput();
                }
            });
            
            // Handle virtual keyboard on mobile
            if ('visualViewport' in window) {
                const visualViewport = window.visualViewport;
                
                visualViewport.addEventListener('resize', () => {
                    if (visualViewport.height < window.innerHeight * 0.7) {
                        // Keyboard is probably open
                        chatContainer.style.height = `${visualViewport.height - 20}px`;
                    } else {
                        // Keyboard is probably closed
                        chatContainer.style.height = '';
                    }
                    
                    scrollToBottom();
                });
            }
            
            // Initialize with a smooth entrance
            setTimeout(() => {
                chatContainer.style.opacity = '1';
                chatContainer.style.transform = 'translateY(0)';
            }, 100);
            
            // Check if PWA is installed
            window.addEventListener('appinstalled', () => {
                console.log('PWA installed');
            });
            
            // Before install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('PWA install available');
            });
        }
    </script>
</body>
</html>
