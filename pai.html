<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-AI Streaming Assistant</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f0f2f5;
        }

        .chat-container {
            width: 90vw;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chat-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-body {
            height: 400px;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .user-message {
            background: #6366f1;
            color: white;
            align-self: flex-end;
            border-radius: 20px 20px 0 20px;
        }

        .bot-message {
            background: #f3f4f6;
            color: #1f2937;
            align-self: flex-start;
            border-radius: 20px 20px 20px 0;
        }

        .input-container {
            padding: 1.5rem;
            display: flex;
            gap: 10px;
            border-top: 2px solid #f3f4f6;
        }

        #user-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            outline: none;
            font-size: 14px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #send-btn {
            background: #6366f1;
            color: white;
        }

        #voice-btn {
            background: #10b981;
            color: white;
        }

        #image-btn {
            background: #f59e0b;
            color: white;
        }

        .streaming-line {
            display: block;
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 5px;
            border: 2px solid #e5e7eb;
        }

        .upload-container {
            position: relative;
            display: inline-block;
        }

        #file-input {
            display: none;
        }

        .ocr-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-top: 5px;
        }

        .ocr-error {
            color: #ef4444;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: #f3f4f6;
            border-radius: 20px;
            margin-left: 8px;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background: #6366f1;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .message-actions {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .action-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: #e5e7eb;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .action-btn:hover {
            background: #d1d5db;
        }

        .bot-message .message-actions {
            left: -25px;
            right: auto;
        }

        .listening {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h3>P-AI Streaming Assistant</h3>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="message bot-message">
                <div class="streaming-line">Hello! I'm your Prabhas-AI assistant.</div>
                <div class="streaming-line" style="animation-delay: 0.3s">You can type, speak, or upload images.</div>
                <div class="streaming-line" style="animation-delay: 0.6s">Ask me anything!</div>
                <div class="message-actions">
                    <button class="action-btn" title="Speak" onclick="speakMessage(this.parentNode.parentNode)">ðŸ”Š</button>
                </div>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message...">
            <div class="upload-container">
                <input type="file" id="file-input" accept="image/*">
                <button id="image-btn" class="btn" title="Upload Image" onclick="document.getElementById('file-input').click()">
                    ðŸ“·
                </button>
            </div>
            <button id="voice-btn" class="btn" title="Voice Input">ðŸŽ¤</button>
            <button id="send-btn" class="btn" title="Send">âž¤</button>
        </div>
    </div>
<script src="config.js"></script>
    <script>
        const chatBody = document.getElementById('chat-body');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const fileInput = document.getElementById('file-input');
       
        
        // Speech synthesis
        const synth = window.speechSynthesis;
        let currentUtterance = null;

        // Initialize Tesseract OCR
        const worker = Tesseract.createWorker();
        (async () => {
            await worker.load();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
        })();

        // Image upload handler
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.src = e.target.result;
                
                const container = document.createElement('div');
                container.className = 'message user-message';
                container.innerHTML = `
                    <div>Uploaded Image:</div>
                    <img src="${img.src}" class="image-preview">
                    <div class="ocr-loading"></div>
                `;
                chatBody.appendChild(container);
                chatBody.scrollTop = chatBody.scrollHeight;

                try {
                    const { data: { text } } = await worker.recognize(file);
                    container.innerHTML = `
                        <div>Uploaded Image:</div>
                        <img src="${img.src}" class="image-preview">
                        <div style="margin-top: 5px">Extracted Text: ${text}</div>
                    `;
                    await handleStreamingResponse(`Image content: ${text}`);
                } catch (error) {
                    console.error('OCR Error:', error);
                    container.innerHTML += `<div class="ocr-error">OCR Failed: ${error.message}</div>`;
                }
            };
            reader.readAsDataURL(file);
        });

        // Show typing indicator
        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot" style="animation-delay: 0.2s"></div>
                <div class="typing-dot" style="animation-delay: 0.4s"></div>
            `;
            chatBody.appendChild(typingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            return typingDiv;
        }

        // Create streaming message
        function createStreamingMessage() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            actionsDiv.innerHTML = `<button class="action-btn" title="Speak" onclick="speakMessage(this.parentNode.parentNode)">ðŸ”Š</button>`;
            messageDiv.appendChild(actionsDiv);
            
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            return messageDiv;
        }

        // Add streaming text
        function addStreamingText(container, text) {
            const lines = text.split('\n');
            lines.forEach((line, index) => {
                if (line.trim() === '') return;
                
                if (index >= container.children.length - 1) {
                    const lineElement = document.createElement('div');
                    lineElement.className = 'streaming-line';
                    lineElement.style.animationDelay = `${index * 0.3}s`;
                    container.insertBefore(lineElement, container.lastChild);
                }
                
                const lineElement = container.children[index];
                lineElement.textContent = line;
            });
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // Text-to-speech
        function speakMessage(messageElement) {
            if (currentUtterance) synth.cancel();
            
            let fullText = '';
            for (let i = 0; i < messageElement.children.length - 1; i++) {
                if (messageElement.children[i].classList.contains('streaming-line')) {
                    fullText += messageElement.children[i].textContent + ' ';
                }
            }
            
            if (fullText.trim()) {
                currentUtterance = new SpeechSynthesisUtterance(fullText);
                currentUtterance.rate = 1.0;
                currentUtterance.pitch = 1.0;
                synth.speak(currentUtterance);
            }
        }

        // Handle AI response
        async function handleStreamingResponse(prompt) {
            const typing = showTyping();
            const messageContainer = createStreamingMessage();
            let fullResponse = '';

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "HTTP-Referer": "https:zu38.github.io",
                        "X-Title": "PAI Chatbot",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "mistralai/mistral-small-3.1-24b-instruct:free",
                        "messages": [{"role": "user", "content": prompt}],
                        "stream": true
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data:') && !line.includes('[DONE]')) {
                            try {
                                const data = JSON.parse(line.substring(5));
                                if (data.choices[0].delta?.content) {
                                    fullResponse += data.choices[0].delta.content;
                                    addStreamingText(messageContainer, fullResponse);
                                }
                            } catch (e) {
                                console.error('Error parsing stream data:', e);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Stream error:', error);
                addStreamingText(messageContainer, `Error: ${error.message}`);
            } finally {
                typing.remove();
            }
        }

        // Voice input
        function handleVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Your browser doesn't support speech recognition. Try Chrome or Edge.");
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            
            voiceBtn.classList.add('listening');
            
            recognition.onstart = () => {
                userInput.placeholder = "Listening...";
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                voiceBtn.classList.remove('listening');
                userInput.placeholder = "Type your message...";
                handleUserInput();
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                voiceBtn.classList.remove('listening');
                userInput.placeholder = "Type your message...";
                if (event.error === 'not-allowed') {
                    alert('Please allow microphone access for voice input.');
                }
            };
            
            recognition.onend = () => {
                voiceBtn.classList.remove('listening');
                userInput.placeholder = "Type your message...";
            };
            
            recognition.start();
        }

        // Handle user input
        async function handleUserInput() {
            const message = userInput.value.trim();
            if (!message) return;

            const userMsg = document.createElement('div');
            userMsg.className = 'message user-message';
            userMsg.textContent = message;
            chatBody.appendChild(userMsg);
            userInput.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;

            await handleStreamingResponse(message);
        }

        // Event listeners
        sendBtn.addEventListener('click', handleUserInput);
        voiceBtn.addEventListener('click', handleVoiceInput);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleUserInput();
            }
        });
    </script>
</body>
</html>
